<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mes.bf.prod.mapper.ProcMapper">

	<!-- 설비조회 -->
	<select id="findMchn" resultType="vmchn">
		SELECT * FROM v_findmchn
		<where>
			<if test="mchnCode != null and mchnCode != ''">
				AND mchn_code LIKE #{mchnCode}
			</if>

			<if test="mchnName != null and mchnName != ''">
				AND mchn_name LIKE #{mchnName}
			</if>

		</where>

	</select>


	<!-- 공정실적전체조회 -->
	<select id="findProcPerform" resultType="vfindprocperformVO">

		SELECT * FROM v_findprocperform
		<where>
			<if test="workSdate != null and workSdate != ''">
	 
				<![CDATA[ AND workdate >= #{workSdate} ]]>
			</if>

			<if test="workEdate != null and workEdate != ''">
				<![CDATA[ AND workdate <= #{workEdate} ]]>
			</if>

			<if test="procCdName != null and procCdName != ''">
				AND proc_cd_name LIKE #{procCdName}
			</if>

			<if test="mchnName != null and mchnName != ''">
				AND mchn_name LIKE #{mchnName}
			</if>

			<if test="empId != null and empId != ''">
				AND workername LIKE #{empId}
			</if>
			
		</where>
		
	</select>

	<!-- 공정명검색 -->
	<select id="findProcCode" resultType="procCode">
		SELECT * FROM BF_CMN_PROC_CODE
		<where>
			<if test="procCdCode != null and procCdCode != ''">
				AND proc_cd_code LIKE #{procCdCode}
			</if>
			<if test="procCdName != null and procCdName != ''">
				AND proc_cd_name LIKE #{procCdName}
			</if>

		</where>
	</select>

	<!-- 공정실적관리테이블 조회 -->

	<select id="findProcManage" resultType="ProcManageVO">
		SELECT * FROM v_procmanage
		<where>
			<if test="finPrdCdName != null and finPrdCdName !=''">
				AND finPrdCdName LIKE #{finPrdCdName}
			</if>
			<if test="workDate != null and workDate !=''">
				AND to_char(workDate,'yyyy-mm-dd') = #{workDate}
			</if>
		</where>
	</select>

	<!-- 공정테이블 조회 -->

	<select id="findProcess"
		resultType="com.mes.bf.prod.vo.ProcessVO">
		SELECT * 
		FROM 
			bf_prod_process
		WHERE 
			inst_prod_no =
			#{instProdNo}
		AND 
			NOT process_order=5
		order by 2,3
	</select>

	<!-- 제품코드로 설비명,상태 조회 -->
	<select id="selectMchn" resultType="MchnVO">
		SELECT 
			mchn.mchn_name,
			mchn.mchn_stts
		FROM 
			BF_EQP_MCHN mchn,
			BF_CMN_LINE_CODE linecode,
			BF_CMN_LINE_CODE_HD linehd,
			BF_CMN_BOM_CODE bomcode
		WHERE 
			mchn.mchn_code = linecode.mchn_code 
		AND
			linecode.line_cd_hd_code = linehd.line_cd_hd_code 
		AND
		linehd.line_cd_hd_code = bomcode.line_cd_hd_code 
		AND
		fin_prd_cd_code = #{finPrdCdCode}
		AND 
		NOT linecode.line_cd_ord = 5
		order by linecode.line_cd_ord
		

	</select>
	
	<!-- 공정명과 작업번호를 받아서 공정테이블 실적량(생산량) 수정 -->
	
	<update id="updateProcVol" parameterType="ProcessVO">
	
	UPDATE 
		BF_PROD_PROCESS 
	SET 
		total_prod_vol = #{totalProdVol} 
	WHERE 
		process_no = #{processNo}
	
	</update>
	
	<!-- 공정테이블 불량수정 -->
	<update id="updateFltyVol" parameterType="ProcessVO">
		UPDATE 
			BF_PROD_PROCESS 
		SET 
			flty_vol = #{fltyVol} 
		WHERE
			process_no = #{processNo}
	</update>
	

	<!-- 설비상태 업데이트 -->	

	<update id="updateMchnStts" parameterType="MchnVO">
		UPDATE
			BF_EQP_MCHN
		SET 
			mchn_stts = #{mchnStts}
		WHERE
			mchn_code = #{mchnCode}
	</update>
	
	<!-- 공정테이블 완료여부 달성률 업데이트   -->
	<update id="updateProcCheck">
		UPDATE
			BF_PROD_PROCESS
		SET
			completion_status = 'y'
			
		WHERE
			process_no = #{processNo}
	
	</update>
	
	<update id="updateachieRate">
		UPDATE
			BF_PROD_PROCESS
		SET
			achie_rate = #{achieRate}	
		WHERE
			process_no = #{processNo}
	</update>
	
	<!-- 공정 실적 테이블 등록 -->
  	<insert id="insertProcPerform" parameterType="ProcessPerformVO">
	INSERT INTO 
		BF_PROD_PROCESS_PERFORMANCE (
									PROCESS_PERFOM_NO,
                                    PROCESS_NO,
                                    PROD_VOL,
                                    FLTY_VOL,
                                    WORK_START_TIME,
                                    WORK_END_TIME,
                                    WORKER_NAME,
                                    prod_date
									)
	VALUES (
			BF_PROD_PROCESS_PERFORMANCE_SEQ.nextval,
			#{processNo},
			#{prodVol},
			#{fltyVol},
			to_timestamp(#{workStartTime}, 'yyyy-MM-dd HH24:mi:ss.ff'),
			to_timestamp(#{workEndTime}, 'yyyy-MM-dd HH24:mi:ss.ff'),
			#{workerName},
			#{prodDate}
			)
	
	</insert>
	
	<!-- 하나의 공정 완료 후 다음 공정 입고량 업데이트 -->
	
	<update id="updateProcInDtlVol" parameterType="ProcessVO">
		UPDATE 
				BF_PROD_PROCESS 
		SET 
				in_dtl_vol = #{inDtlVol}
 		WHERE 
				inst_prod_no = #{instProdNo}
 		AND 
				process_order = #{processOrder}
	
	</update>
	
	
	<!-- 공정실적 테이블 조회 -->
	
	<select id="getProcPerform" resultType="ProcessPerformVO">
	SELECT * 
	FROM 
		BF_PROD_PROCESS_PERFORMANCE 
	WHERE process_no = #{processNo}
	
	</select>
	
	
</mapper>